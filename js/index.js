// Generated by CoffeeScript 1.7.1

/*
    Author: Dalston Xu
    Updated: 2014年4月12日13:07:58
 */

(function() {
  var bg_img_0, bg_img_1, bg_music_0, bg_music_1, getLocation, getWeatherByCityName, getWeatherByGeoCoords, renderUI, updateWeatherInfo, utils;

  document.addEventListener('DOMContentLoaded', function() {
    return getLocation();
  });

  bg_img_0 = function() {
    return $('#background').attr({
      "src": "./images/china_0.jpg"
    });
  };

  bg_img_1 = function() {
    var image;
    image = document.getElementById('background');
    image.onload = function() {
      var engine;
      engine = new RainyDay({
        image: this
      });
      engine.trail = engine.TRAIL_SMUDGE;
      return engine.rain([[1, 0, 100], [3, 3, 1], [1, 4, 20]], 100);
    };
    image.crossOrigin = 'anonymous';
    return image.src = './images/shanghai.jpg';
  };

  bg_music_0 = function() {
    return soundManager.setup({
      onready: function() {
        var music;
        music = soundManager.createSound({
          id: 'music',
          url: 'audio/qing_long_guo.mp3',
          multiShotEvents: true,
          onload: function() {
            return this.play({
              position: 0
            });
          },
          onfinish: function() {
            return this.play({
              position: 0
            });
          }
        });
        return music.play();
      }
    });
  };

  bg_music_1 = function() {
    var audioSpan;
    audioSpan = 7288;
    return soundManager.setup({
      onready: function() {
        var rain1, rain2, t;
        rain1 = soundManager.createSound({
          id: 'rain1',
          url: 'audio/rainfade_1.mp3',
          autoLoad: true,
          multiShotEvents: true,
          onload: function() {
            return this.play({
              position: 0
            });
          },
          onfinish: function() {
            return this.play({
              position: 0
            });
          }
        });
        rain1.play();
        t = false;
        rain2 = soundManager.createSound({
          id: 'rain2',
          url: 'audio/rainfade_1.mp3',
          autoLoad: true,
          multiShotEvents: true,
          onload: function() {
            return this.play({
              volume: 0,
              position: audioSpan
            });
          },
          onfinish: function() {
            return this.play({
              position: 0
            });
          },
          onplay: function() {
            var e, i, n, r;
            if (t) {
              return false;
            }
            e = 3 * 1e3;
            n = 0;
            r = 100;
            return i = setInterval(function() {
              rain2.setVolume((1 + n) * (r / 12));
              n++;
              if (n === 12) {
                clearInterval(i);
                return t = true;
              }
            }, e / 12);
          }
        });
        return rain2.play();
      }
    });
  };

  getLocation = function() {
    var error, success;
    success = function(position) {
      $("#aside").addClass("show");
      $("#geo_info").text(position);
      return getWeatherByGeoCoords([position.coords.latitude, position.coords.longtitude]);
    };
    error = function(error) {
      switch (error.code) {
        case error.PERMISSION_DENIED:
          console.info("PERMISSION_DENIED");
          break;
        case error.POSITION_UNAVAILABLE:
          console.info("POSITION_UNAVAILABLE");
          break;
        case error.TIMEOUT:
          console.info("TIMEOUT");
          break;
        case error.UNKNOWN_ERROR:
          console.info("UNKNOWN_ERROR");
      }
      return $.get("http://ipinfo.io", function(response) {
        var coords;
        $("#aside").addClass("show");
        coords = response.loc.split(",");
        if (response.city !== null) {
          $("#geo_info").text(response.city);
          return getWeatherByCityName(response.city);
        } else {
          $("#geo_info").text(response.loc);
          return getWeatherByGeoCoords(coords[0], coords[1]);
        }
      }, "jsonp");
    };
    return navigator.geolocation.getCurrentPosition(success, error);
  };

  getWeatherByCityName = function(cityName) {
    return $.get("http://api.openweathermap.org/data/2.5/weather?q=" + cityName + "&APPID=cb44c4f3d297066b575ecf0bf5dd0751 ", function(response) {
      return updateWeatherInfo(response);
    }, "jsonp");
  };

  getWeatherByGeoCoords = function(lat, lon) {
    return $.get("http://api.openweathermap.org/data/2.5/weather?lat=" + lat + "&lon=" + lon + "&APPID=cb44c4f3d297066b575ecf0bf5dd0751 ", function(response) {
      return updateWeatherInfo(response);
    }, "jsonp");
  };

  updateWeatherInfo = function(weatherInfo) {
    var weather_icon, weather_id, weather_main, weather_temp;
    weather_main = weatherInfo.weather[0].main;
    weather_icon = weatherInfo.weather[0].icon;
    weather_id = weatherInfo.weather[0].id;
    weather_temp = weatherInfo.main.temp;
    $("#weather_icon").attr({
      "src": "http://openweathermap.org/img/w/" + weather_icon + ".png",
      "title": weather_main,
      "alt": weather_main
    });
    $("#aside").addClass(weather_main);
    $("#weather_text").text(weather_main);
    $("#weather_temp").text(weather_temp + " °F");
    return renderUI(weather_id);
  };

  renderUI = function(weatherConditionCode) {
    var uiType;
    uiType = utils.condition2ui(weatherConditionCode);
    switch (uiType) {
      case 0:
        bg_music_0();
        return bg_img_0();
      case 1:
        bg_music_1();
        return bg_img_1();
    }
  };

  utils = {};

  utils.condition2ui = function(weatherConditionCode) {
    var uiType;
    return uiType = (function() {
      switch (false) {
        case Math.floor(weatherConditionCode / 100) !== 8:
          return 0;
        default:
          return 1;
      }
    })();
  };

}).call(this);
